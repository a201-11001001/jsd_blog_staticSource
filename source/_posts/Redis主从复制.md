---
title: Redis主从复制
date: 2023-12-07 21:17:51
tags: 
    - Redis
description: RabbitMQ避免消息不丢失 ## 页面描述
keywords: 加密  ## 关键字
comments: true  ## 评论模块
cover: /top_img/Redis主从复制top_img.jpg
## 文章缩略图
# top_img:  ## 顶部图片
aside: false  ## 显示侧边栏（默认 true）
---

#### Redis主从复制实现原理
主从复制，是指将一台Redis服务器的数据，复制到其他的Redis服务器。前者称为主节点(master)，后者称为从节点(slave)；数据的复制是单向的，只能由主节点到从节点。

##### 作用
* 数据冗余(由于从节点是主节点的副本，主节点数据的备份可以在从节点上实现)
* 高可用性(通过将数据复制到多个从节点，即使主节点发生故障，从节点可替代主节点提供服务，从而保障系统的高可用性。)
* 读写分离(主节点提供写服务,从节点提供读服务,分担主节点的负载,提高系统的整体性能)

##### 主从复制原理 
> * 从服务向主服务器发送 psync 命令,主服务器收到命令后在本地生成 RDB 文件 ==> 
> * 生成 RDB 文件的同时会在本地创建缓冲区(用来存储 RDB 文件存储过程写入的新的命令) ==> 
> * 将RDB 文件发送到从服务器 ==> 
> * 从服务器收到之后先将本地的 RDB 文件删除,然后将发送过来的 RDB 文件在本地恢复 ==>
> * 主服务器发送缓冲区的命令 ==> 
> * 从服务器开始接收缓存区的命令写入本地

![Redis主从复制](Redis主从复制原理.png)

##### 全量复制
全量复制是 Redis 最早支持的复制方式，触发全量复制的命令是 sync 和 psync。
* 从服务发送 psync 命令进行数据同步，由于是第一次进行复制，从节点没有复制偏移量和主节点运行 id，所以发送 psync ？-1。
* 主节点接收从节点的命令后，主节点根据 psync ? -1 解析出当前为全量复制，所以回复 +FULLRESYNC，同时也会将自身的 runid 和 offset 偏移量发送给从节点，响应为 +FULLRESYNC {runid} {offset}。
* 从节点接受主节点的响应后，会保存主节点的 runid 和偏移量
* 主节点执行 bgsave 保存 RDB 文件到本地，主节点发送 RDB 文件给从节点，从节点把接受的 RDB 文件保存在本地，并直接作为从节点的数据文件，接受完 RDB 文件后从节点打印相关日志。
* 从节点开始接受 RDB 文件到接受完成期间，主节点仍然响应读写命令，因此主节点会把这期间写命令保存在客户端的缓冲区中，当从节点加载完 RDB 文件后，主节点在把缓冲区的数据发送给从节点，已保证主从之间的数据一致性。如果主节点和从节点 RDB 文件的数据传输时间过长时，按上面分析可能会造成客户端的缓冲区溢出。默认配置为 client-output-buffer-limit slave 256MB 64MB 60。 如果 60 秒内缓冲区消耗大于 64MB 或者超过 256MB 时，主节点将直接关闭客户端连接，造成全量同步失败。
* 从节点接受完主节点传送来的全部数据后会清空自身的旧数据。
* 从节点成功加载完 RDB 文件后，如果当前节点开启了 AOF 持久化功能，它会立刻做 AOF 重写操作 (bgrewriteaof) 操作，为了保证全量复制后 AOF 持久化文件立刻可用

##### 部分复制
> 部分复制主要是 Redis 针对全量复制的过高开销做出的一种优化措施
* 当主从节点之间网络出现中断时，如果超过 repl-timeout 时间，主节点会认为从节点故障并中断复制连接。
* 由于主节点没有宕机，所以他依然会响应客户端命令，但因复制连接中断命令无法发送给从节点，但主节点内部会将这段时间的命令保存在客户端缓冲区中，默认大小为 1MB。
* 当主从节点网络恢复后，从节点会再次连接上主节点。当主从节点连接恢复后，由于从节点之前保存了自身的偏移量和主节点的运行 id。因此会把它们当作 psync 参数发送给主节点，要求进行部分复制操作。
* 主节点接受从节点的 psync 命令，会先核对请求的 runid 是否和自身的的 runid 一致，如果一致，说明该从节点复制的当前主节点。然后查偏移量是否相等，如果不等则进行部分复制，如果相同则表示数据一致不需要复制
* 在进行部分复制时，主节点只需要根据偏移量将复制积压缓冲区的数据发送给从节点，保证主从复制进入正常状态

##### 心跳
在命令传播阶段，除了发送写命令，主从节点还维持着心跳机制：ping 和 replconf ack。心跳机制对于主从复制的超时判断、数据安全等有作用。

主从节点彼此都有心跳检测机制，各自模拟成对方的客户端进行通信，通过 client list 命令查看复制客户端信息，主节点的连接状态为 flags = M，从节点连接状态为 flags = S。
主节点默认每隔 10 秒对从节点发送 ping 命令，判断从节点的存活性和连接状态，可能通过 repl-ping-slave-period 参数修改发送频率。
从节点在主线程中每隔 1 秒发送 replconf ack{offset} 命令，给主节点上报自身当前的偏移量。


